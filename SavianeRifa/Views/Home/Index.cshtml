@{
    ViewData["Title"] = "Home Page";
}

<div class="row">
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="row g-0">
                <div class="col-md-4 d-flex align-items-center justify-content-center p-3">
                    <!-- Foto da cunhada: substitua a src pela foto real -->
                    <img id="foto-cunhada" src="/images/foto-cunhada-placeholder.jpg" alt="Foto da beneficiária" class="img-fluid rounded" style="max-height:250px; object-fit:cover;" />
                </div>
                <div class="col-md-8">
                    <div class="card-body">
                        <h2 class="card-title">Ajude com o tratamento</h2>
                        <p class="card-text">Este projeto tem por objetivo arrecadar fundos para ajudar nos custos do tratamento da minha cunhada, que é portadora de insuficiência renal. Ao adquirir rifas você estará contribuindo diretamente com consultas, medicamentos e deslocamentos. Obrigado pelo apoio.</p>
                        <p class="card-text"><small class="text-muted">Escolha uma ou mais rifas abaixo. Rifas já vendidas aparecem desabilitadas.</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h3>Rifas disponíveis</h3>
            <div>
                <span class="me-3">Selecionadas: <span id="selected-count">0</span></span>
                <button id="concluir-btn" class="btn btn-primary" disabled data-bs-toggle="modal" data-bs-target="#pixModal">Concluir compra</button>
            </div>
        </div>

        <div id="rifas-list" class="row g-3">
            <!-- Rifas serão renderizadas por JS (substitua por rendering server-side quando integrar) -->
        </div>
    </div>
</div>

<!-- Modal PIX -->
<div class="modal fade" id="pixModal" tabindex="-1" aria-labelledby="pixModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pixModalLabel">Pagamento via PIX</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p>Escaneie o QRCode abaixo com o app do seu banco ou copie a chave PIX.</p>
        <img id="pix-qr" src="" alt="QR Code PIX" class="img-fluid mb-3" style="max-width:260px;" />
        <div>
            <strong>Chave PIX:</strong>
            <div class="input-group mb-2 justify-content-center" style="max-width:420px;">
                <input type="text" id="pix-key" class="form-control text-center" readonly value="00020126330014BR.GOV.BCB.PIX0111024596262075204000053039865406500.005802BR5923ANDREY COSTA DE QUEIROZ6006MANAUS610869090090623450300017BR.GOV.BCB.BRCODE01051.0.06304EB7E" />
                <button class="btn btn-outline-secondary" id="copy-pix">Copiar</button>
            </div>
        </div>
        <p class="mt-2">Total: <strong id="total-amount">R$ 0,00</strong></p>
        <small class="text-muted">Após a confirmação do pagamento, registre os dados para finalizar a venda (ex.: nome, telefone).</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        // Dados de exemplo. Quando integrar ao backend, gere esse JSON no servidor e substitua aqui.
        const rifas = [
            { id: 1, numero: '001', preco: 10.00, vendido: false },
            { id: 2, numero: '002', preco: 10.00, vendido: true },
            { id: 3, numero: '003', preco: 10.00, vendido: false },
            { id: 4, numero: '004', preco: 10.00, vendido: false },
            { id: 5, numero: '005', preco: 10.00, vendido: true },
            { id: 6, numero: '006', preco: 10.00, vendido: false }
        ];

        const pixKey = document.getElementById('pix-key').value; // substitua pela chave real

        function formatBRL(v){
            return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function renderRifas(){
            const container = document.getElementById('rifas-list');
            container.innerHTML = '';
            rifas.forEach(r => {
                const col = document.createElement('div');
                col.className = 'col-6 col-md-4 col-lg-3';

                const card = document.createElement('div');
                card.className = 'card h-100';

                const body = document.createElement('div');
                body.className = 'card-body d-flex flex-column';

                const title = document.createElement('h5');
                title.className = 'card-title';
                title.textContent = 'Rifa ' + r.numero;

                const price = document.createElement('p');
                price.className = 'card-text mb-2';
                price.textContent = formatBRL(r.preco);

                const footer = document.createElement('div');
                footer.className = 'mt-auto';

                const inputGroup = document.createElement('div');
                inputGroup.className = 'form-check';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input select-rifa';
                checkbox.id = 'rifa-' + r.id;
                checkbox.dataset.id = r.id;
                checkbox.dataset.price = r.preco;
                if(r.vendido){
                    checkbox.disabled = true;
                }

                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = checkbox.id;
                label.textContent = r.vendido ? 'Vendida' : 'Disponível';

                inputGroup.appendChild(checkbox);
                inputGroup.appendChild(label);

                if(r.vendido){
                    const soldBadge = document.createElement('span');
                    soldBadge.className = 'badge bg-danger ms-2';
                    soldBadge.textContent = 'VENDIDA';
                    inputGroup.appendChild(soldBadge);
                }

                footer.appendChild(inputGroup);

                body.appendChild(title);
                body.appendChild(price);
                body.appendChild(footer);

                card.appendChild(body);
                col.appendChild(card);
                container.appendChild(col);
            });

            // attach change handlers
            document.querySelectorAll('.select-rifa').forEach(cb => cb.addEventListener('change', onSelectionChange));
            onSelectionChange();
        }

        function onSelectionChange(){
            const selected = Array.from(document.querySelectorAll('.select-rifa:checked'));
            const count = selected.length;
            document.getElementById('selected-count').textContent = count;
            const concluirBtn = document.getElementById('concluir-btn');
            concluirBtn.disabled = count === 0;
        }

        function calculateTotal(){
            const selected = Array.from(document.querySelectorAll('.select-rifa:checked'));
            const total = selected.reduce((s, el) => s + parseFloat(el.dataset.price || 0), 0);
            return total;
        }

        // Antes de abrir o modal, atualizar QR e total
        document.getElementById('concluir-btn').addEventListener('click', function(){
            const total = calculateTotal();
            document.getElementById('total-amount').textContent = formatBRL(total);

            // Gera QRCode via API pública (troque pela sua geração/servidor quando preferir)
            //const pixPayload = `pix:${pixKey}|amount:${total.toFixed(2)}`; // placeholder
            //const qrSrc = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(pixKey + '|' + total.toFixed(2));
            
            const qrSrc = "data:image/png;base64,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"
            document.getElementById('pix-qr').src = qrSrc;
        });

        // copiar chave PIX
        document.getElementById('copy-pix').addEventListener('click', function(){
            const keyEl = document.getElementById('pix-key');
            keyEl.select();
            try{
                document.execCommand('copy');
                this.textContent = 'Copiado';
                setTimeout(()=> this.textContent = 'Copiar', 2000);
            }catch(e){
                alert('Selecione e copie a chave manualmente: ' + keyEl.value);
            }
        });

        // Inicialização
        renderRifas();
    </script>
}
