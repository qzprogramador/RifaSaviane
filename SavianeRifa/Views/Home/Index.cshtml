@{
    ViewData["Title"] = "Home Page";
}

<div class="row">
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="row g-0">
                <div class="col-md-4 d-flex align-items-center justify-content-center p-3">
                    <!-- Foto da cunhada: substitua a src pela foto real -->
                    <img id="foto-cunhada" src="/images/foto-cunhada-placeholder.jpg" alt="Foto da beneficiária" class="img-fluid rounded" style="max-height:250px; object-fit:cover;" />
                </div>
                <div class="col-md-8">
                    <div class="card-body">
                        <h2 class="card-title">Ajude com o tratamento</h2>
                        <p class="card-text">Este projeto tem por objetivo arrecadar fundos para ajudar nos custos do tratamento da minha cunhada, que é portadora de insuficiência renal. Ao adquirir rifas você estará contribuindo diretamente com consultas, medicamentos e deslocamentos. Obrigado pelo apoio.</p>
                        <p class="card-text"><small class="text-muted">Escolha uma ou mais rifas abaixo. Rifas já vendidas aparecem desabilitadas.</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h3>Rifas disponíveis</h3>
            <div>
                <span class="me-3">Selecionadas: <span id="selected-count">0</span></span>
                <button id="concluir-btn" class="btn btn-primary" disabled data-bs-toggle="modal" data-bs-target="#pixModal">Concluir compra</button>
            </div>
        </div>

        <div id="rifas-list" class="row g-3">
            <!-- Rifas serão renderizadas por JS (substitua por rendering server-side quando integrar) -->
        </div>
    </div>
</div>

<!-- Modal PIX -->
<div class="modal fade" id="pixModal" tabindex="-1" aria-labelledby="pixModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pixModalLabel">Pagamento via PIX</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p>Escaneie o QRCode abaixo com o app do seu banco ou copie a chave PIX.</p>
        <img id="pix-qr" src="" alt="QR Code PIX" class="img-fluid mb-3" style="max-width:260px;" />
        <div>
            <strong>Chave PIX:</strong>
            <div class="input-group mb-2 justify-content-center" style="max-width:420px;">
                <input type="text" id="pix-key" class="form-control text-center" readonly value="minha-chave-pix@example.com" />
                <button class="btn btn-outline-secondary" id="copy-pix">Copiar</button>
            </div>
        </div>
        <p class="mt-2">Total: <strong id="total-amount">R$ 0,00</strong></p>
        <small class="text-muted">Após a confirmação do pagamento, registre os dados para finalizar a venda (ex.: nome, telefone).</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        // Dados de exemplo. Quando integrar ao backend, gere esse JSON no servidor e substitua aqui.
        const rifas = [
            { id: 1, numero: '001', preco: 10.00, vendido: false },
            { id: 2, numero: '002', preco: 10.00, vendido: true },
            { id: 3, numero: '003', preco: 10.00, vendido: false },
            { id: 4, numero: '004', preco: 10.00, vendido: false },
            { id: 5, numero: '005', preco: 10.00, vendido: true },
            { id: 6, numero: '006', preco: 10.00, vendido: false }
        ];

        const pixKey = document.getElementById('pix-key').value; // substitua pela chave real

        function formatBRL(v){
            return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function renderRifas(){
            const container = document.getElementById('rifas-list');
            container.innerHTML = '';
            rifas.forEach(r => {
                const col = document.createElement('div');
                col.className = 'col-6 col-md-4 col-lg-3';

                const card = document.createElement('div');
                card.className = 'card h-100';

                const body = document.createElement('div');
                body.className = 'card-body d-flex flex-column';

                const title = document.createElement('h5');
                title.className = 'card-title';
                title.textContent = 'Rifa ' + r.numero;

                const price = document.createElement('p');
                price.className = 'card-text mb-2';
                price.textContent = formatBRL(r.preco);

                const footer = document.createElement('div');
                footer.className = 'mt-auto';

                const inputGroup = document.createElement('div');
                inputGroup.className = 'form-check';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input select-rifa';
                checkbox.id = 'rifa-' + r.id;
                checkbox.dataset.id = r.id;
                checkbox.dataset.price = r.preco;
                if(r.vendido){
                    checkbox.disabled = true;
                }

                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = checkbox.id;
                label.textContent = r.vendido ? 'Vendida' : 'Disponível';

                inputGroup.appendChild(checkbox);
                inputGroup.appendChild(label);

                if(r.vendido){
                    const soldBadge = document.createElement('span');
                    soldBadge.className = 'badge bg-danger ms-2';
                    soldBadge.textContent = 'VENDIDA';
                    inputGroup.appendChild(soldBadge);
                }

                footer.appendChild(inputGroup);

                body.appendChild(title);
                body.appendChild(price);
                body.appendChild(footer);

                card.appendChild(body);
                col.appendChild(card);
                container.appendChild(col);
            });

            // attach change handlers
            document.querySelectorAll('.select-rifa').forEach(cb => cb.addEventListener('change', onSelectionChange));
            onSelectionChange();
        }

        function onSelectionChange(){
            const selected = Array.from(document.querySelectorAll('.select-rifa:checked'));
            const count = selected.length;
            document.getElementById('selected-count').textContent = count;
            const concluirBtn = document.getElementById('concluir-btn');
            concluirBtn.disabled = count === 0;
        }

        function calculateTotal(){
            const selected = Array.from(document.querySelectorAll('.select-rifa:checked'));
            const total = selected.reduce((s, el) => s + parseFloat(el.dataset.price || 0), 0);
            return total;
        }

        // Antes de abrir o modal, atualizar QR e total
        document.getElementById('concluir-btn').addEventListener('click', function(){
            const total = calculateTotal();
            document.getElementById('total-amount').textContent = formatBRL(total);

            // Gera QRCode via API pública (troque pela sua geração/servidor quando preferir)
            const pixPayload = `pix:${pixKey}|amount:${total.toFixed(2)}`; // placeholder
            const qrSrc = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(pixKey + '|' + total.toFixed(2));
            document.getElementById('pix-qr').src = qrSrc;
        });

        // copiar chave PIX
        document.getElementById('copy-pix').addEventListener('click', function(){
            const keyEl = document.getElementById('pix-key');
            keyEl.select();
            try{
                document.execCommand('copy');
                this.textContent = 'Copiado';
                setTimeout(()=> this.textContent = 'Copiar', 2000);
            }catch(e){
                alert('Selecione e copie a chave manualmente: ' + keyEl.value);
            }
        });

        // Inicialização
        renderRifas();
    </script>
}
